<!doctype html>
<html lang="en">
<head>
  <title>Mining Monitor</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

  <style>
  #device_table td { white-space: nowrap }
  
  </style>

  <script type="text/javascript">

    var ws;
    var svg;
    var gpuMap = {};
    var paramAlias = {};
    
    function hashrate(rate){
      if(!rate){
        return 0.0
      }else if(rate > 1e6){
        return (rate/1e6).toFixed(3) + " MH/s";
      }else if(rate > 1e3){
        return (rate/1e3).toFixed(3) + " kH/s";
      }else{
        return rate.toFixed(3) + " H/s";
      }
    }


    function init() {
      // Connect to Web Socket
      address = window.location.hostname == "localhost" ? "localhost:9090" : window.location.hostname;
      address = "sf.while1.no";
      
      let reconnect = null;

      let connect =  () => {
        console.log("connecting");
        let ws = new WebSocket("ws://"+address+"/miner-monitor/ws");
      

        // Set event handlers.
        ws.onopen = function() {
          output("onopen");
          if(reconnect)
            clearInterval(reconnect)
        };

        ws.onclose = () => {
          output("onclose");
          if(reconnect)
            clearTimeout(reconnect)
        
          reconnect = setTimeout(() => {
            console.log("reconnecting")
            connect();
          }, 2000);
        
        }

        ws.onmessage = function(e) {
          // e.data contains received string.
          data = JSON.parse(e.data)
          //console.log("onmessage: ", data);

          if(data.param){
            for (let e of document.getElementsByClassName(data.param)){
              e.innerHTML = parseInt(data.value)
            }
            for (let e of svg.getElementsByClassName(data.param)){
              e.innerHTML = parseInt(data.value)
            }
            for (let a of paramAlias[data.param] || []){
              for (let e of svg.getElementsByClassName(a)){
                e.innerHTML = parseInt(data.value)
              }
            }
          } else if(data.type){
            switch(data.type){
              case "device.algo":
                let selector = "#device_table .device_row[device='"+data.device_id+"']";
                
                if(!document.querySelector(selector)){
                  let t = document.querySelector('#device_table_row');
                  let el = document.importNode(t.content, true);
                  el.firstElementChild.setAttribute("device", data.device_id);
                  el.querySelector(".device_temperature").classList.add("t_gpu."+data.device_id);
                  document.querySelector('#device_table tbody').appendChild(el);

                  paramAlias["t_gpu."+data.device_id] = ["t_gpu."+data.device_uuid];
                }
                
                let el = document.querySelector(selector)
                
                el.querySelector(".device_id").innerHTML = data.device_id;
                el.querySelector(".device_uuid").innerHTML = data.device_uuid;
                el.querySelectorAll("button").forEach(e => e.setAttribute("device", data.device_id))
                el.querySelector(".algo").innerHTML = data.algo;
                el.querySelector(".speed").innerHTML = hashrate(data.speed);
                el.querySelector(".paying").innerHTML = (data.paying ? data.paying.toFixed(3) : 0.0) + " mBTC/d";
              
                gpuMap[data.device_id] = data;

              break;
            }
          }
        };
        
        ws.onerror = function(e) {
          output("onerror");
          console.log(e)
        };

        return ws;
      }

      /*reconnect = setInterval(() => {
        console.log("reconnecting")
        let tws = connect();
        if(tws){
          ws = tws;
        }
      }, 2000);
      */

      // Connect
      connect();
  }
    
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }
    
    function onCloseClick() {
      ws.close();
    }
    
    function output(str) {
      /*
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      log.innerHTML = escaped + "<br>" + log.innerHTML;
      */
      console.log(str)
    }



  $(document).ready(function(){

    // Prepare svg
      document.getElementById("pnid").addEventListener("load",function(o) {
        let doc = o.target.contentDocument;
        svg = doc;

        // Set class for updates
        for (let e of doc.querySelectorAll("span, div")){
          if(e.innerHTML == e.innerText){
            console.log(e.innerText);
            e.setAttribute("class", e.innerText);

          }
        }
        
      }, false);


      $(document).on("click", "button.device-enable", function(e){
        let packet = {
            cmd: "device.enable",
            device_id: parseInt(e.target.attributes.device.value),
            enable: e.target.attributes.value.value == "1"
          };
          ws.send(JSON.stringify(packet));
      });



  });


  </script>
  
  <template id="device">
    <div class="device" device="99">
      <span>Device <span class="device_id">99</span>: </span><button class="device-enable" device="99" value="1">Enable</button> <button class="device-enable" device="99" value="0">Disable</button> <span class="algo"></span> (<span class="speed"></span> / <span class="paying"></span> mBTC/day)
    </div>
  </template>

  <template id="device_table_row">
    <tr class="device_row" device="99">
      <th class="device_id">Id</th>
      <td class="algo">Algorithm</td>
      <td class="speed">Algorithm</td>
      <td class="paying">Algorithm</td>
      <td class="device_temperature">0.0</td>
      <td><button class="device-enable" device="99" value="1">Enable</button> <button class="device-enable" device="99" value="0">Disable</button></td>
      <td class="device_uuid">uuid</td>
    </tr>
  </template>

</head>
<body onload="init();">

	<object type="image/svg+xml" data="piping.svg" id="pnid" style="margin: 10px; width: 100%; max-width: 1000px;">
</object>

<table id="device_table" class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Id</th>
      <th scope="col">Algorithm</th>
      <th scope="col">Speed</th>
      <th scope="col">Paying</th>
      <th scope="col">Temperature</th>
      <th scope="col"></th>
      <th scope="col">UUID</th>
    </tr>
  </thead>
  <tbody>

  </tbody>
</table>

</body>
</html>
